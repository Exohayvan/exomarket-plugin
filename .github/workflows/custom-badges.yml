name: Update badges

on:
  push:
    branches: [ main ]
    paths-ignore:
      - ".badges/**"
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: badges-main
  cancel-in-progress: false

jobs:
  badges:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure .badges folder
        run: |
          set -euo pipefail
          mkdir -p .badges

      - name: SonarCloud - Reliability (reliability_rating)
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=reliability_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          printf '{"schemaVersion":1,"label":"RELIABILITY","message":"%s","color":"%s"}\n' "$grade" "$color" \
            > .badges/reliability.json

      - name: SonarCloud - Maintainability (sqale_rating)
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=sqale_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          printf '{"schemaVersion":1,"label":"MAINTAINABILITY","message":"%s","color":"%s"}\n' "$grade" "$color" \
            > .badges/maintainability.json

      - name: SonarCloud - Vulnerabilities (vulnerabilities)
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=vulnerabilities"
          svg="$(curl -fsSL "$url")"

          # Try to pull the number robustly
          count="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+</text>' | head -n1 | sed -E 's/.*>([0-9]+)<.*/\1/' || true)"
          [ -n "${count:-}" ] || count="?"

          if [ "$count" = "?" ]; then
            color="lightgrey"
          elif [ "$count" -eq 0 ]; then
            color="brightgreen"
          elif [ "$count" -le 5 ]; then
            color="yellow"
          else
            color="red"
          fi

          printf '{"schemaVersion":1,"label":"VULNERABILITIES","message":"%s","color":"%s"}\n' "$count" "$color" \
            > .badges/vulnerabilities.json

      - name: SonarCloud - Duplicated Lines (duplicated_lines_density)
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=duplicated_lines_density"
          svg="$(curl -fsSL "$url")"

          pct="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+(\.[0-9]+)?%</text>' | head -n1 | sed -E 's/.*>([0-9]+(\.[0-9]+)?%)<.*/\1/' || true)"

          if [ -z "${pct:-}" ]; then
            pct="?"
            color="lightgrey"
          else
            num="$(printf '%s' "$pct" | sed 's/%//')"
            band="$(awk -v n="$num" 'BEGIN{ if(n<3) print 1; else if(n<7) print 2; else if(n<15) print 3; else print 4 }')"
            case "$band" in
              1) color="brightgreen" ;;
              2) color="yellow" ;;
              3) color="orange" ;;
              4) color="red" ;;
              *) color="lightgrey" ;;
            esac
          fi

          printf '{"schemaVersion":1,"label":"DUPLICATED LINES","message":"%s","color":"%s"}\n' "$pct" "$color" \
            > .badges/duplicated_lines.json
  
      - name: SonarCloud - Security (security_rating)
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=security_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          printf '{"schemaVersion":1,"label":"SECURITY","message":"%s","color":"%s"}\n' "$grade" "$color" \
            > .badges/security.json

      - name: CodeTabs - Totals (Total files + Total linesOfCode)
        run: |
          set -euo pipefail
          api="https://api.codetabs.com/v1/loc/?github=ExoHayvan/StarhavenSMP-Core"
          json="$(curl -fsSL "$api" | tr '\n' ' ')"

          # Grab the Total object chunk, then extract numbers
          total_chunk="$(printf '%s' "$json" | grep -oE '\{[^}]*"language"[[:space:]]*:[[:space:]]*"Total"[^}]*\}' | head -n1 || true)"

          files="$(printf '%s' "$total_chunk" | grep -oE '"files"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"
          loc="$(printf '%s' "$total_chunk"   | grep -oE '"linesOfCode"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"

          [ -n "${files:-}" ] || files="?"
          [ -n "${loc:-}" ] || loc="?"

          printf '{"schemaVersion":1,"label":"FILES","message":"%s","color":"blue"}\n' "$files" \
            > .badges/files.json
          printf '{"schemaVersion":1,"label":"LINES OF CODE","message":"%s","color":"blue"}\n' "$loc" \
            > .badges/lines_of_code.json

      - name: Commit & push badges (only if changed)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .badges/*.json
          git diff --cached --quiet && exit 0

          git commit -m "chore: update badges"
          git push
