name: Update badges

on:
  push:
    branches: [ main ]
    paths-ignore:
      - ".badges/**"
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

# Prevent two runs racing and fighting over commits
concurrency:
  group: badges-main
  cancel-in-progress: false

jobs:
  reliability_badge:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate reliability badge JSON
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=reliability_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          mkdir -p .badges
          printf '{"schemaVersion":1,"label":"RELIABILITY","message":"%s","color":"%s"}\n' "$grade" "$color" > .badges/reliability.json

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .badges/reliability.json
          git diff --cached --quiet && exit 0
          git commit -m "chore: update reliability badge"
          git push

  maintainability_badge:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate maintainability badge JSON
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=sqale_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          mkdir -p .badges
          printf '{"schemaVersion":1,"label":"MAINTAINABILITY","message":"%s","color":"%s"}\n' "$grade" "$color" > .badges/maintainability.json

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .badges/maintainability.json
          git diff --cached --quiet && exit 0
          git commit -m "chore: update maintainability badge"
          git push

  vulnerabilities_badge:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate vulnerabilities badge JSON
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=vulnerabilities"
          svg="$(curl -fsSL "$url")"

          # Prefer: number after label, fallback: first integer <text>
          count="$(printf '%s' "$svg" | tr '\n' ' ' \
            | sed -E 's/.*vulnerabilities<\/text>[[:space:]]*<text[^>]*>vulnerabilities<\/text>[[:space:]]*<text[^>]*>[0-9]+<\/text>[[:space:]]*<text[^>]*>([0-9]+)<\/text>.*/\1/' \
            | grep -E '^[0-9]+$' || true)"

          if [ -z "${count:-}" ]; then
            count="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+</text>' | head -n1 | sed -E 's/.*>([0-9]+)<.*/\1/' || true)"
          fi
          [ -n "${count:-}" ] || count="?"

          if [ "$count" = "?" ]; then
            color="lightgrey"
          elif [ "$count" -eq 0 ]; then
            color="brightgreen"
          elif [ "$count" -le 5 ]; then
            color="yellow"
          else
            color="red"
          fi

          mkdir -p .badges
          printf '{"schemaVersion":1,"label":"VULNERABILITIES","message":"%s","color":"%s"}\n' "$count" "$color" > .badges/vulnerabilities.json

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .badges/vulnerabilities.json
          git diff --cached --quiet && exit 0
          git commit -m "chore: update vulnerabilities badge"
          git push

  duplicated_lines_badge:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate duplicated lines badge JSON
        run: |
          set -euo pipefail
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=duplicated_lines_density"
          svg="$(curl -fsSL "$url")"

          pct="$(printf '%s' "$svg" | tr '\n' ' ' \
            | sed -E 's/.*duplicated lines<\/text>[[:space:]]*<text[^>]*>duplicated lines<\/text>[[:space:]]*<text[^>]*>[0-9.]+%<\/text>[[:space:]]*<text[^>]*>([0-9.]+%)<\/text>.*/\1/' \
            | grep -E '^[0-9]+(\.[0-9]+)?%$' || true)"

          if [ -z "${pct:-}" ]; then
            pct="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+(\.[0-9]+)?%</text>' | head -n1 | sed -E 's/.*>([0-9]+(\.[0-9]+)?%)<.*/\1/' || true)"
          fi

          if [ -z "${pct:-}" ]; then
            pct="?"
            color="lightgrey"
          else
            num="$(printf '%s' "$pct" | sed 's/%//')"
            band="$(awk -v n="$num" 'BEGIN{ if(n<3) print 1; else if(n<7) print 2; else if(n<15) print 3; else print 4 }')"
            case "$band" in
              1) color="brightgreen" ;;
              2) color="yellow" ;;
              3) color="orange" ;;
              4) color="red" ;;
              *) color="lightgrey" ;;
            esac
          fi

          mkdir -p .badges
          printf '{"schemaVersion":1,"label":"DUPLICATED LINES","message":"%s","color":"%s"}\n' "$pct" "$color" > .badges/duplicated_lines.json

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .badges/duplicated_lines.json
          git diff --cached --quiet && exit 0
          git commit -m "chore: update duplicated lines badge"
          git push

  codetabs_totals_badge:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate CodeTabs totals badges JSON (files + LoC)
        run: |
          set -euo pipefail
          api="https://api.codetabs.com/v1/loc/?github=ExoHayvan/StarhavenSMP-Core"
          json="$(curl -fsSL "$api")"

          # Pull the "Total" object. Avoid jq dependency by using a safe-ish regex.
          total_block="$(printf '%s' "$json" | tr '\n' ' ' | sed -E 's/.*\{[[:space:]]*"language"[[:space:]]*:[[:space:]]*"Total"[^}]*\}.*/\0/' )"

          # Extract totals using regex (works with CodeTabs' stable keys)
          files="$(printf '%s' "$json" | tr '\n' ' ' | grep -oE '"language"[[:space:]]*:[[:space:]]*"Total"[^}]*' | head -n1 | grep -oE '"files"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"
          loc="$(printf '%s' "$json"   | tr '\n' ' ' | grep -oE '"language"[[:space:]]*:[[:space:]]*"Total"[^}]*' | head -n1 | grep -oE '"linesOfCode"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"

          [ -n "${files:-}" ] || files="?"
          [ -n "${loc:-}" ] || loc="?"

          # Simple colors (tweak if you want)
          files_color="blue"
          loc_color="blue"

          mkdir -p .badges
          printf '{"schemaVersion":1,"label":"FILES","message":"%s","color":"%s"}\n' "$files" "$files_color" > .badges/files.json
          printf '{"schemaVersion":1,"label":"LINES OF CODE","message":"%s","color":"%s"}\n' "$loc" "$loc_color" > .badges/lines_of_code.json

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .badges/files.json .badges/lines_of_code.json
          git diff --cached --quiet && exit 0
          git commit -m "chore: update codetabs totals badges"
          git push
