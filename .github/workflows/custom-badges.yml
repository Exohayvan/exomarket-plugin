name: Update badges

on:
  push:
    branches: [ main ]
    paths-ignore:
      - ".badges/**"
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: badges-main
  cancel-in-progress: false

jobs:
  badges:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure .badges folder
        run: |
          set -euo pipefail
          mkdir -p .badges

      - name: SonarCloud - Reliability (reliability_rating)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=reliability_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          badge_path=".badges/reliability.json"
          badge_content="$(printf '{"schemaVersion":1,"label":"RELIABILITY","message":"%s","color":"%s"}' "$grade" "$color")"
          write_badge "$badge_path" "$badge_content"

      - name: SonarCloud - Maintainability (sqale_rating)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=sqale_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          badge_path=".badges/maintainability.json"
          badge_content="$(printf '{"schemaVersion":1,"label":"MAINTAINABILITY","message":"%s","color":"%s"}' "$grade" "$color")"
          write_badge "$badge_path" "$badge_content"

      - name: SonarCloud - Vulnerabilities (vulnerabilities)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=vulnerabilities"
          svg="$(curl -fsSL "$url")"

          # Try to pull the number robustly
          count="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+</text>' | head -n1 | sed -E 's/.*>([0-9]+)<.*/\1/' || true)"
          [ -n "${count:-}" ] || count="?"

          if [ "$count" = "?" ]; then
            color="lightgrey"
          elif [ "$count" -eq 0 ]; then
            color="brightgreen"
          elif [ "$count" -le 5 ]; then
            color="yellow"
          else
            color="red"
          fi

          badge_path=".badges/vulnerabilities.json"
          badge_content="$(printf '{"schemaVersion":1,"label":"VULNERABILITIES","message":"%s","color":"%s"}' "$count" "$color")"
          write_badge "$badge_path" "$badge_content"

      - name: SonarCloud - Duplicated Lines (duplicated_lines_density)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=duplicated_lines_density"
          svg="$(curl -fsSL "$url")"

          pct="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[0-9]+(\.[0-9]+)?%</text>' | head -n1 | sed -E 's/.*>([0-9]+(\.[0-9]+)?%)<.*/\1/' || true)"

          if [ -z "${pct:-}" ]; then
            pct="?"
            color="lightgrey"
          else
            num="$(printf '%s' "$pct" | sed 's/%//')"
            band="$(awk -v n="$num" 'BEGIN{ if(n<3) print 1; else if(n<7) print 2; else if(n<15) print 3; else print 4 }')"
            case "$band" in
              1) color="brightgreen" ;;
              2) color="yellow" ;;
              3) color="orange" ;;
              4) color="red" ;;
              *) color="lightgrey" ;;
            esac
          fi

          badge_path=".badges/duplicated_lines.json"
          badge_content="$(printf '{"schemaVersion":1,"label":"DUPLICATED LINES","message":"%s","color":"%s"}' "$pct" "$color")"
          write_badge "$badge_path" "$badge_content"
  
      - name: SonarCloud - Security (security_rating)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          project="Exohayvan_StarhavenSMP-Core"
          url="https://sonarcloud.io/api/project_badges/measure?project=${project}&metric=security_rating"
          svg="$(curl -fsSL "$url")"

          grade="$(printf '%s' "$svg" | grep -oE '<text[^>]*>[A-E]</text>' | head -n1 | sed -E 's/.*>([A-E])<.*/\1/' || true)"
          [ -n "${grade:-}" ] || grade="?"

          case "$grade" in
            A) color="brightgreen" ;;
            B) color="green" ;;
            C) color="yellow" ;;
            D) color="orange" ;;
            E) color="red" ;;
            *) color="lightgrey" ;;
          esac

          badge_path=".badges/security.json"
          badge_content="$(printf '{"schemaVersion":1,"label":"SECURITY","message":"%s","color":"%s"}' "$grade" "$color")"
          write_badge "$badge_path" "$badge_content"

      - name: Update coverage badge
        run: |
          set -euo pipefail

          SVG_URL="https://sonarcloud.io/api/project_badges/measure?project=Exohayvan_StarhavenSMP-Core&metric=coverage"
          svg="$(curl -fsSL "$SVG_URL")"

          # Extract coverage percentage (e.g. 72.4%)
          coverage="$(printf '%s' "$svg" \
            | grep -oE '<text[^>]*>[0-9]+(\.[0-9]+)?%</text>' \
            | head -n1 \
            | sed -E 's/.*>([0-9.]+%).*/\1/')"

          # Strip % for numeric comparison
          value="${coverage%\%}"

          # Map percentage â†’ color
          awk -v v="$value" 'BEGIN {
            if (v >= 80) print "brightgreen";
            else if (v >= 70) print "green";
            else if (v >= 50) print "yellow";
            else if (v >= 30) print "orange";
            else print "red";
          }' > /tmp/coverage_color

          color="$(cat /tmp/coverage_color)"

          mkdir -p .badges
          cat > .badges/coverage.json <<EOF
          {
            "schemaVersion": 1,
            "label": "COVERAGE",
            "message": "$coverage",
            "color": "$color"
          }
          EOF

      - name: CodeTabs - Totals (Total files + Total linesOfCode)
        run: |
          set -euo pipefail
          write_badge() {
            local path="$1"
            local content="$2"
            local tmp
            tmp="$(mktemp)"
            printf '%s\n' "$content" > "$tmp"
            if [ -f "$path" ] && cmp -s "$tmp" "$path"; then
              echo "Badge unchanged: $path"
              rm "$tmp"
              return 0
            fi
            mv "$tmp" "$path"
            echo "Badge updated: $path"
          }
          api="https://api.codetabs.com/v1/loc/?github=ExoHayvan/StarhavenSMP-Core"
          json="$(curl -fsSL "$api" | tr '\n' ' ')"

          # Grab the Total object chunk, then extract numbers
          total_chunk="$(printf '%s' "$json" | grep -oE '\{[^}]*"language"[[:space:]]*:[[:space:]]*"Total"[^}]*\}' | head -n1 || true)"

          files="$(printf '%s' "$total_chunk" | grep -oE '"files"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"
          loc="$(printf '%s' "$total_chunk"   | grep -oE '"linesOfCode"[[:space:]]*:[[:space:]]*[0-9]+' | head -n1 | grep -oE '[0-9]+' || true)"

          [ -n "${files:-}" ] || files="?"
          [ -n "${loc:-}" ] || loc="?"

          files_path=".badges/files.json"
          files_content="$(printf '{"schemaVersion":1,"label":"FILES","message":"%s","color":"blue"}' "$files")"
          write_badge "$files_path" "$files_content"

          loc_path=".badges/lines_of_code.json"
          loc_content="$(printf '{"schemaVersion":1,"label":"LINES OF CODE","message":"%s","color":"blue"}' "$loc")"
          write_badge "$loc_path" "$loc_content"

      - name: Commit & push badges (only if changed)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .badges/*.json
          git diff --cached --quiet && exit 0

          git commit -m "chore: update badges"
          git push
